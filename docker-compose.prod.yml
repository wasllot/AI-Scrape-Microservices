version: '3.8'

services:
  # ============================================
  # Traefik - Production SSL Configuration
  # ============================================
  traefik:
    command:
      - "--api.insecure=false" # Disable insecure API in production
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global HTTP -> HTTPS Redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Let's Encrypt Resolver
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      # - "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory" # Uncomment for testing to avoid rate limits
      - "--certificatesresolvers.myresolver.acme.email=admin@reinaldotineo.online"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    volumes:
      - ./letsencrypt:/letsencrypt

  # ============================================
  # AI Service
  # ============================================
  ai-service:
    environment:
      - APP_ENV=production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai-service.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/ai`)"
      - "traefik.http.routers.ai-service.entrypoints=websecure"
      - "traefik.http.routers.ai-service.tls.certresolver=myresolver"
      - "traefik.http.services.ai-service.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.ai-strip-prefix.stripprefix.prefixes=/ai"
      - "traefik.http.routers.ai-service.middlewares=ai-strip-prefix"

  # ============================================
  # Business Core
  # ============================================
  business-core:
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.business-core.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/app`)"
      - "traefik.http.routers.business-core.entrypoints=websecure"
      - "traefik.http.routers.business-core.tls.certresolver=myresolver"
      - "traefik.http.services.business-core.loadbalancer.server.port=80"
      - "traefik.http.middlewares.business-strip-prefix.stripprefix.prefixes=/app"
      - "traefik.http.routers.business-core.middlewares=business-strip-prefix"

  # ============================================
  # Scraper Service
  # ============================================
  scraper-service:
    environment:
      - APP_ENV=production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.scraper-service.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/scraper`)"
      - "traefik.http.routers.scraper-service.entrypoints=websecure"
      - "traefik.http.routers.scraper-service.tls.certresolver=myresolver"
      - "traefik.http.services.scraper-service.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.scraper-strip-prefix.stripprefix.prefixes=/scraper"
      - "traefik.http.routers.scraper-service.middlewares=scraper-strip-prefix"

  # ============================================
  # Queue Worker
  # ============================================
  queue-worker:
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
