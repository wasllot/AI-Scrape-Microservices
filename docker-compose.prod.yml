version: '3.8'

services:
  # ============================================
  # Traefik - Behind Nginx Proxy
  # ============================================
  traefik:
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      # Expose Traefik on 8090 -> 80 (internal)
      # Nginx will proxy pass to localhost:8090
      - "8090:80"
      # - "443:443"  <-- DISABLED: SSL handled by Nginx
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ============================================
  # AI Service
  # ============================================
  ai-service:
    command: [ "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--root-path", "/ai" ]
    environment:
      - APP_ENV=production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai-service.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/ai`)"
      - "traefik.http.routers.ai-service.entrypoints=web"
      - "traefik.http.services.ai-service.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.ai-strip-prefix.stripprefix.prefixes=/ai"
      - "traefik.http.routers.ai-service.middlewares=ai-strip-prefix"

  # ============================================
  # Business Core
  # ============================================
  business-core:
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.business-core.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/app`)"
      - "traefik.http.routers.business-core.entrypoints=web"
      - "traefik.http.services.business-core.loadbalancer.server.port=80"
      - "traefik.http.middlewares.business-strip-prefix.stripprefix.prefixes=/app"
      - "traefik.http.routers.business-core.middlewares=business-strip-prefix"
      # Router for direct /api access (no strip prefix, so Laravel receives /api/...)
      - "traefik.http.routers.business-core-api.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/api`)"
      - "traefik.http.routers.business-core-api.entrypoints=web"
      - "traefik.http.routers.business-core-api.service=business-core"

  # ============================================
  # Scraper Service
  # ============================================
  scraper-service:
    command: [ "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--root-path", "/scraper" ]
    environment:
      - APP_ENV=production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.scraper-service.rule=Host(`api.reinaldotineo.online`) && PathPrefix(`/scraper`)"
      - "traefik.http.routers.scraper-service.entrypoints=web"
      - "traefik.http.services.scraper-service.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.scraper-strip-prefix.stripprefix.prefixes=/scraper"
      - "traefik.http.routers.scraper-service.middlewares=scraper-strip-prefix"

  # ============================================
  # Queue Worker
  # ============================================
  queue-worker:
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
